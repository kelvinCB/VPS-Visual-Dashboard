name: Deploy to VPS (PM2)

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          # If you use a non-standard SSH port, change this value.
          port: 22
          script_stop: true
          script: |
            set -euo pipefail
            
            # Use specific app directory
            TARGET_DIR="/home/kelvin/.clawdbot/workspace/repos/VPS-Visual-Dashboard"
            
            # Diagnostic
            echo "[deploy] Diagnostic Start"
            whoami
            pwd
            
            if [ ! -d "$TARGET_DIR" ]; then
              echo "[error] Target directory $TARGET_DIR does not exist!"
              exit 1
            fi
            
            cd "$TARGET_DIR"

            # Add safe directory to avoid ownership issues
            git config --global --add safe.directory "$TARGET_DIR" || true
            git config --global --add safe.directory /home/kelvin/.openclaw/workspace/repos/VPS-Visual-Dashboard || true

            # Reset and Pull
            git fetch origin main --prune
            git reset --hard origin/main

            # Run deploy script
            chmod +x scripts/deploy.sh
            APP_DIR="$TARGET_DIR" BRANCH=main ./scripts/deploy.sh
            echo "[deploy] Diagnostic End"
